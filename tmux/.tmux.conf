# Configuration {{{

# Fix tmux not using correct color scheme
set-option -g default-terminal "tmux-256color"
set-option -sa terminal-overrides ",alacritty:Tc"
set-option -sa terminal-overrides ",*:Smulx=\E[4::%p1%dm"  # undercurl support
set-option -sa terminal-overrides ",*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m"  # underscore colours - needs tmux-3.0

# set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
# set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# Increase scroll back history
# set -g history-limit 5000

# Make sure we always start at 1, even when invoked from a .tmux wrapper script
set-environment -g SHLVL 1

# use vi key bindings
set-option -g mode-keys vi

# Mouse
set-option -g mouse on

# Decrease command delay (increases vim responsiveness)
# set -sg escape-time 10

# Increase repeat time for repeatable commands
set-option -g repeat-time 1000

# Start window index at 1 instead of 0
set-option -g base-index 1

# Start pane index at 1 instead of 0
set-option -g pane-base-index 1

# Highlight window when it has new activity
set-option -g monitor-activity on
set-option -g visual-activity off

# Re-number windows when one is closed
set-option -g renumber-windows on

set-option -g set-titles on
# set-option -g set-titles-string '#{session_name}'
set-option -g set-titles-string '#T'

# Don't wrap searchers; it's super confusing given tmux's reverse-ordering of
# position in copy mode.
set-option -w -g wrap-search off

# Slightly more useful width in "main-vertical" layout; enough room for 3-digit
# line number gutter in Vim + 80 columns of text + 1 column breathing room
# (default looks to be about 79).
set-option -w -g main-pane-width 85

# Enable OSC 52 clipboard
set-option -g set-clipboard on

# Add : to the default list (" -_@") of word separators.
set-option -ga word-separators :/

# https://github.com/tmux/tmux/issues/353#issuecomment-265154018
# set -g focus-events on
# End Configuration }}}

# Key Bindings {{{
# To see current bindings:
#     tmux list-keys


# Remap prefix to <C-a>
unbind-key C-b
set-option -g prefix C-a
# When we actually want to send `C-a` instead of the prefix,
# We press `C-a` twice so we get the actual `C-a`.
bind-key C-a send-prefix

# Open new/split panes with the path of the current pane
unbind-key %
bind-key % split-window -h -c '#{pane_current_path}'
unbind-key '"'
bind-key '"' split-window -v -c '#{pane_current_path}'

# This key suspends the current tmux client and I don't know how to unsuspend
# it. Better off disabling this since I've never really used it.
# Pressing Prefix + z and Prefix + <C-z> makes me accidentally press this
unbind C-z

# Sensible new/split panes key bindings
bind-key | split-window -h -c '#{pane_current_path}'
bind-key \\ split-window -h -c '#{pane_current_path}'
bind-key - split-window -v -c '#{pane_current_path}'

# Vim-like keybindings for pane navigation (uses the arrow keys by default)
unbind-key h
bind-key h select-pane -L
unbind-key j
bind-key j select-pane -D
unbind-key k
bind-key k select-pane -U
unbind-key l  # normally used for last-window
bind-key l select-pane -R

# Repeatedly resize-pane using HJKL
bind-key -r H resize-pane -L 2
bind-key -r J resize-pane -D 2
bind-key -r K resize-pane -U 2
bind-key -r L resize-pane -R 2

# Setup 'v' to begin selection like Vim
bind-key -T copy-mode-vi 'v' send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'
bind-key -T copy-mode-vi WheelUpPane send-keys -X scroll-up
bind-key -T copy-mode-vi WheelDownPane send-keys -X scroll-down

# Move window to left
bind-key < swap-window -t -1
# Move window to right
bind-key > swap-window -t +1

# Stay in copy-mode on drag end
# (Would use `bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X
# stop-selection` but it is a bit glitchy.)
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# Scroll 3 lines at a time instead of default 5; don't extend dragged selections.
bind-key -T copy-mode-vi WheelUpPane select-pane\; send-keys -t'{mouse}' -X clear-selection\; send-keys -t'{mouse}' -X -N 3 scroll-up
bind-key -T copy-mode-vi WheelDownPane select-pane\; send-keys -t'{mouse}' -X clear-selection\; send-keys -t'{mouse}' -X -N 3 scroll-down

# Make double and triple click work outside of copy mode (already works inside it with default bindings).
bind-key -T root DoubleClick1Pane if-shell -Ft'{mouse}' '#{alternate_on}' "send-keys -M" "copy-mode -t'{mouse}'; send-keys -X select-word"
bind-key -T root TripleClick1Pane if-shell -Ft'{mouse}' '#{alternate_on}' "send-keys -M" "copy-mode -t'{mouse}'; send-keys -X select-line"

# break session and kill session
# https://forum.upcase.com/t/how-do-you-manage-organize-sessions-projects-with-tmux-workflow/740/5
bind-key C-b send-keys 'tat && exit' 'C-m'

# toggle between synchronizing panes
bind-key y set synchronize-panes\; display 'synchronize-panes #{?synchronize-panes,on,off}'

# Reload tmux config
bind-key R source-file ~/.tmux.conf \; display "Config reloaded."

# Search back to last prompt (mnemonic: "[b]ack"); Only works when you use
# pure prompt
bind-key b copy-mode\; send-keys -X start-of-line\; send-keys -X search-backward "‚ùØ"\; send-keys -X next-word

bind-key -T copy-mode-vi / command-prompt -i -p "search down" "send -X search-forward-incremental \"%%%\""
bind-key -T copy-mode-vi ? command-prompt -i -p "search up" "send -X search-backward-incremental \"%%%\""


# Analagous with naked C-l which resets/clears the terminal.
bind-key C-l clear-history
# End Key Bindings }}}

# Status Bar {{{

# Enable UTF-8 Support in status bar
# set -gq status-utf8 on

# Set refresh interval
# set -g status-interval 30

# Center the status bar
# set -g status-justify centre

# Show session, window, pane in left status bar
# set-option -g status-left-length 40
set-option -g status-left-length 100
set-option -g status-left-style NONE

set-option -g status-right-length 100
set-option -g status-right-style NONE

# set-option -g status-left '#[fg=#]tmux: #[fg=colour141]#S '
set-option -g status-left "#[fg=#1d202f,bg=#7aa2f7] #S #[fg=#7aa2f7,bg=#1f2335,nobold,nounderscore,noitalics]ÓÇ∞"
# Show hostname
# set-option -g status-right '#[fg=cyan]cpu: #{cpu_fg_color}#{cpu_percentage} #[fg=cyan]uptime: #[fg=magenta]#{uptime} #{pomodoro_status}'

set-option -g status-right "#[fg=#1f2335,bg=#1f2335,nobold,nounderscore,noitalics]ÓÇ≤#[fg=#7aa2f7,bg=#1f2335] #{prefix_highlight} #[fg=#3b4261,bg=#1f2335,nobold,nounderscore,noitalics]ÓÇ≤#[fg=#7aa2f7,bg=#3b4261] cpu: #{cpu_fg_color}#{cpu_percentage} #[fg=#7aa2f7,bg=#3b4261]ÓÇ≥ %I:%M %p #[fg=#7aa2f7,bg=#3b4261,nobold,nounderscore,noitalics]#{pomodoro_status}ÓÇ≤#[fg=#1D202F,bg=#7aa2f7,bold] #h"


set-option -g @pomodoro_mins 52
set-option -g @pomodoro_break_mins 17
set-option -g @pomodoro_on "ÓÇ≥ #[fg=red]üçÖ #[fg=#7aa2f7,bg=#3b4261,nobold,nounderscore,noitalics]"
set-option -g @pomodoro_complete "ÓÇ≥ #[fg=green]üçÖ #[fg=#7aa2f7,bg=#3b4261,nobold,nounderscore,noitalics]"

set-option -g @pomodoro_start '0'
set-option -g @pomodoro_cancel '9'
## }}}

# Colors {{{

# Status Bar
set-option -g status-style "fg=#7aa2f7,bg=#1f2335"

# Window
set-option -g window-status-format "#[fg=#1f2335,bg=#1f2335,nobold,nounderscore,noitalics]ÓÇ∞#[default] #I ÓÇ± #W #F #[fg=#1f2335,bg=#1f2335,nobold,nounderscore,noitalics]ÓÇ∞"
set-option -g window-status-current-format "#[fg=#1f2335,bg=#3b4261,nobold,nounderscore,noitalics]ÓÇ∞#[fg=#7aa2f7,bg=#3b4261,bold] #I ÓÇ± #W #F #[fg=#3b4261,bg=#1f2335,nobold,nounderscore,noitalics]ÓÇ∞"
set-option -g window-status-activity-style "fg=#7aa2f7,bg=#1f2335"


# Panes
set-option -g pane-border-style "fg=#3b4261"
set-option -g pane-active-border-style "fg=#7aa2f7"

# Message bar
set-option -g message-style "fg=#7aa2f7,bg=#3b4261"
set-option -g message-command-style "fg=#7aa2f7,bg=#3b4261"

# Mode
set-option -g mode-style "fg=#7aa2f7,bg=#3b4261"

## }}}

# Plugins {{{
# From https://github.com/tmux-plugins/tpm#installation
# Put at the bottom of the conf
# List of plugins
# Install: Prefix + I
# Update: Prefix + U
# Remove: Prefix + Alt + U
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# Install custom plugins here
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'robhurring/tmux-uptime'
set -g @plugin 'tmux-plugins/tmux-urlview'
set -g @plugin 'olimorris/tmux-pomodoro-plus'
# set -g @plugin 'tmux-plugins/tmux-sessionist'

set -g @continuum-save-interval '20'
# set -g @resurrect-strategy-nvim 'session'

# set -g @continuum-restore 'on'

# Automatically install tpm
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run -b '~/.tmux/plugins/tpm/tpm'
# }}}

# Local config
if-shell "[ -f ~/.tmux-local.conf ]" 'source ~/.tmux-local.conf'
# vim:filetype=tmux sw=4 foldmethod=marker tw=78 expandtab:
